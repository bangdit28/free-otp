<!DOCTYPE html>
<html lang="id" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Jasa OTP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Admin Panel</a>
        </div>
    </nav>

    <main class="container mt-4">
        <!-- Panel Manajemen Stok -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h4 class="mb-0">Manajemen Stok Nomor</h4>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="service-select" class="form-label">Layanan</label>
                        <select id="service-select" class="form-select">
                            <option value="facebook">Facebook</option>
                            <option value="google">Google</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="country-select" class="form-label">Negara</label>
                        <select id="country-select" class="form-select">
                            <!-- Opsi akan diisi oleh JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="number-textarea" class="form-label">Daftar Nomor (satu per baris)</label>
                        <textarea id="number-textarea" class="form-control" rows="4" placeholder="62812...&#10;6012..."></textarea>
                    </div>
                    <div class="col-md-2">
                        <button id="add-stock-btn" class="btn btn-primary w-100">Tambah</button>
                    </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>Stok Tersedia:</strong>
                    <span id="stock-count-display" class="badge bg-success fs-6">Pilih layanan & negara</span>
                </div>
                 <div id="feedback-message" class="mt-2"></div>
            </div>
        </div>

        <!-- Panel Pesanan Aktif -->
        <h2 class="mb-3">Pesanan Aktif</h2>
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Layanan</th>
                        <th>Nomor Telepon</th>
                        <th>Input Kode OTP</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <!-- Data dimuat oleh JS -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="js/admin.js"></script>
</body>
</html>```

---

### **Langkah 3: Perbarui File JavaScript (Tambahkan Logika Pengambilan Data)**

Sekarang kita akan memerintahkan JavaScript untuk mengambil data dari `config/countries` yang sudah Anda buat di Firebase dan mengisikannya ke dropdown yang sudah kita kosongkan tadi.

#### **File untuk direvisi: `js/dashboard.js`**

Ganti seluruh isi file `js/dashboard.js` dengan kode ini.

```javascript
// Ganti dengan konfigurasi Firebase Anda
const firebaseConfig = {
    apiKey: "AIza...",
    authDomain: "your-project-id.firebaseapp.com",
    databaseURL: "https://your-project-id-default-rtdb.firebaseio.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "...",
    appId: "..."
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// --- Elemen DOM ---
const getOrderBtn = document.getElementById('getOrderBtn');
const activeOrdersTbody = document.getElementById('active-orders-tbody');
const logoutBtn = document.getElementById('logout-btn');
const countrySelect = document.getElementById('country-select');
const activeTimers = {};

// --- Logika Menu Mobile ---
const menuToggle = document.getElementById('menu-toggle');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebar-overlay');
menuToggle.addEventListener('click', () => { document.body.classList.toggle('sidebar-open'); });
sidebarOverlay.addEventListener('click', () => { document.body.classList.remove('sidebar-open'); });


// ======================================================
// FUNGSI UNTUK MEMUAT NEGARA DARI FIREBASE
// ======================================================
function loadCountries() {
    const countriesRef = database.ref('config/countries');
    countriesRef.once('value', (snapshot) => {
        const countries = snapshot.val();
        if (countries) {
            countrySelect.innerHTML = ''; // Kosongkan daftar yang ada
            for (const key in countries) {
                const option = document.createElement('option');
                option.value = key; // contoh: "indonesia"
                option.textContent = countries[key]; // contoh: "Indonesia"
                countrySelect.appendChild(option);
            }
        } else {
            // Beri tahu pengguna jika tidak ada negara yang dikonfigurasi
            countrySelect.innerHTML = '<option>Tidak ada negara</option>';
            getOrderBtn.disabled = true;
        }
    });
}


// ======================================================
// BAGIAN 1: AUTHENTICATION GUARD & SETUP
// ======================================================
let currentUserId = null;
auth.onAuthStateChanged(user => {
    if (user) {
        currentUserId = user.uid;
        loadUserOrders();
        loadCountries(); // Panggil fungsi untuk memuat negara saat user login
    } else {
        window.location.href = 'index.html';
    }
});
logoutBtn.addEventListener('click', () => { auth.signOut(); });


// ======================================================
// BAGIAN 2: LOGIKA UTAMA
// ======================================================

function loadUserOrders() {
    if (!currentUserId) return;
    const userOrdersRef = database.ref(`orders/${currentUserId}`);

    userOrdersRef.on('child_added', (snapshot) => {
        const orderId = snapshot.key;
        const orderData = snapshot.val();
        if (orderData.status !== 'finished_by_user') {
            addOrUpdateOrderRow(orderId, orderData);
        }
    });
    
    userOrdersRef.on('child_changed', (snapshot) => {
        const orderId = snapshot.key;
        const orderData = snapshot.val();
        if (orderData.status === 'finished_by_user') {
            const row = document.getElementById(`order-${orderId}`);
            if (row) row.remove();
        } else {
            addOrUpdateOrderRow(orderId, orderData);
        }
    });

    userOrdersRef.on('child_removed', (snapshot) => {
        const orderId = snapshot.key;
        const row = document.getElementById(`order-${orderId}`);
        if (row) row.remove();
    });
}

function addOrUpdateOrderRow(orderId, data) {
    let row = document.getElementById(`order-${orderId}`);
    if (!row) {
        row = document.createElement('tr');
        row.id = `order-${orderId}`;
        activeOrdersTbody.prepend(row);
    }
    
    let phoneHTML = `<div class="spinner-border spinner-border-sm" role="status"></div>`;
    if (data.status === 'out_of_stock') {
        phoneHTML = `<span class="text-danger fw-bold">Stok Habis</span>`;
    } else if (data.phoneNumber) {
        phoneHTML = `${data.phoneNumber} <i class="bi bi-clipboard copy-icon" onclick="copyToClipboard('${data.phoneNumber}', this)"></i>`;
    }

    let otpHTML = data.otpCode ? `<span class="otp-code">${data.otpCode}</span> <i class="bi bi-clipboard copy-icon" onclick="copyToClipboard('${data.otpCode}', this)"></i>` : '<div class="spinner-border spinner-border-sm"></div>';
    
    let actionHTML = `<i class="bi bi-hourglass-split"></i>`;
    if (data.otpCode) {
        actionHTML = `<button class="btn btn-sm btn-success action-btn" onclick="finishOrder('${orderId}')"><i class="bi bi-check-lg"></i> Selesai</button>`;
    }
    if (data.status === 'out_of_stock') {
         actionHTML = `<i class="bi bi-x-circle-fill text-danger"></i>`;
    }
    
    row.innerHTML = `
        <td>${data.serviceName}</td>
        <td class="phone-cell">${phoneHTML}</td>
        <td class="otp-cell">${otpHTML}</td>
        <td class="timer-cell">--:--</td>
        <td class="status-cell">${actionHTML}</td>
    `;

    const createdAt = data.createdAt || Date.now();
    const timeElapsed = (Date.now() - createdAt) / 1000;
    const remainingSeconds = Math.round(600 - timeElapsed);

    if (remainingSeconds > 0) {
        startTimer(orderId, remainingSeconds);
    } else {
        const timerCell = row.querySelector('.timer-cell');
        timerCell.textContent = "Expired";
        if (data.status !== 'finished_by_user') {
             setTimeout(() => { if (document.getElementById(`order-${orderId}`)) { document.getElementById(`order-${orderId}`).remove(); } }, 3000);
        }
    }
}

getOrderBtn.addEventListener('click', () => {
    if (!currentUserId || !countrySelect.value) return;

    const orderId = database.ref().child('orders').push().key;
    const serviceName = 'Facebook';
    const selectedCountry = countrySelect.value;

    const newOrderData = {
        serviceName: serviceName,
        price: 1500,
        status: 'waiting_number',
        phoneNumber: '',
        otpCode: '',
        country: selectedCountry,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    database.ref(`orders/${currentUserId}/${orderId}`).set(newOrderData);
});

function finishOrder(orderId) {
    if (!currentUserId) return;
    database.ref(`orders/${currentUserId}/${orderId}`).update({ status: 'finished_by_user' });
}

// ======================================================
// BAGIAN 3: FUNGSI UTILITAS
// ======================================================
function startTimer(orderId, seconds) {
    if (activeTimers[orderId]) clearInterval(activeTimers[orderId]);
    const timerCell = document.querySelector(`#order-${orderId} .timer-cell`);
    if (!timerCell) return;
    
    let remaining = seconds;
    timerCell.textContent = formatTime(remaining);

    activeTimers[orderId] = setInterval(() => {
        remaining--;
        timerCell.textContent = formatTime(remaining);
        if (remaining <= 0) {
            clearInterval(activeTimers[orderId]);
            timerCell.textContent = "Expired";
            setTimeout(() => { const row = document.getElementById(`order-${orderId}`); if (row) row.remove(); }, 3000);
        }
    }, 1000);
}
function formatTime(s) { const m=Math.floor(s/60); return `${m}:${(s%60)<10?'0':''}${s%60}`; }
function copyToClipboard(text,el){navigator.clipboard.writeText(text).then(()=>{const i=el.className;el.className='bi bi-check-lg text-success';setTimeout(()=>el.className=i,1500)})}
